<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="" />
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors" />
  <meta name="generator" content="Jekyll v3.8.5" />

  <title>查看討論版 ｜ NCU MIS SA</title>

  <!-- Bootstrap core CSS -->
  <link href="statics/css/bootstrap.min.css" rel="stylesheet" />
  <link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon" />
  <link href="statics/icon/favicon.ico" type="image/x-icon" rel="shortcut icon" />

  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous" />

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous">
  </script>


  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  <!-- Custom styles for this template -->
  <link href="statics/css/product.css" rel="stylesheet" />

  <script src="statics/js/jquery-3.4.1.min.js"></script>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html"><i class="fas fa-bed me-1"></i> 宿舍管理系統</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="index.html">首頁</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="member.html"><strong>會員管理</strong></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">公告欄</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="discussion_board.html">討論版</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">宿舍繳費</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dormManagement.html">宿舍報修</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">報到手續</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">退宿手續</a>
          </li>
          <div id="loginOrNot"></div>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">


    <div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
      <h1 class="display-4">查看討論版</h1>
    </div>

    <a id="deletePost" class="btn btn-danger float-end">
      刪除文章
      <i class="fas fa-trash"></i>
    </a>
    <div class="clearfix"></div>
    <hr />
    <div class="discussion_board">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <img width="400px" height="400px" src="https://picsum.photos/seed/picsum/200/200" class="card-img-top"
              alt="..." />
            <div class="card-body">
              <p class="card-text p-2">
                <div class="article-title_div">
                  <span class="col-4 me-3">
                    文章標題
                  </span>
                  <span class="col-8" id="article_title">
                    {{article_title}}
                  </span>
                </div>
                <div class="article-content_div">
                  <span class="col-4 me-3">
                    文章內容
                  </span>
                  <span class="col-8 ms-3" id="article_content">
                    {{article_content}}
                  </span>
                </div>
                <div class="author_div">
                  <span class="col-4 me-3">
                    作者
                  </span>
                  <span class="col-8 ms-3" id="author">
                    {{author}}
                  </span>
                </div>

              </p>

            </div>

          </div>
        </div>
      </div>
    </div>
    <div class="row mt-3 text-align-center">
      <div class="d-flex message ms-3">
        <input type="text" placeholder="想要留下什麼話" class="form-control" id="leave_message" aria-describedby="message">
        <span class="justify-content-end">
          <button id="add_message" type="button" class="btn btn-outline-primary ">新增留言<i
              class="fas fa-plus"></i></button>
        </span>
      </div>



    </div>

    <hr>
    <div class="pass_message">
      <h6>過去留言</h6>
      <div id="message_data"></div>
    </div>

  </div>

  <script>
    var url_string = window.location.href;
    var url = new URL(url_string);
    var id = url.searchParams.get("id");
    var name = "";
    Message_data = "";

    getDiscussionData(); //獲得文章資料
    getMessageData(); //獲得留言資料
    checkLogin(); //檢查登入

    //get discussion data
    function getDiscussionData() {
      $.ajax({
        type: "GET",
        url: "api/discussion.do",
        data: "id=" + id,
        crossDomain: true,
        cache: false,
        dataType: "json",
        timeout: 5000,
        success: function (response) {
          if (response.status == 200) {
            updateHTML(response.response.data);

          }
        },
        error: function () {
          alert("無法連線到伺服器！");
        },
      });
    }

    //get message data
    function getMessageData() {
      $.ajax({
        type: "GET",
        url: "api/comment.do",
        data: "id=" + id,
        crossDomain: true,
        cache: false,
        dataType: 'json',
        timeout: 5000,
        success: function (response) {
          if (response.status == 200) {
            var message_data = '';
            
            $.each(response.response.data, function () {
              message_data += updateMessage(this);
            })

            $("#message_data").append(message_data);

          }
        },
        error: function () {
          alert("無法連線到伺服器！");
        }
      });



    }

    //delete message data
    function delete_message(id) {
      var check = window.confirm("確認刪除此筆留言？");
      if (check == true) {
        console.log("You pressed OK!");
        var request = {
          'id': id
        };
        var data_string = JSON.stringify(request);
        $.ajax({
          type: "DELETE",
          url: "api/comment.do",
          crossDomain: true,
          data: data_string,
          cache: false,
          dataType: 'json',
          timeout: 5000,
          success: function (response) {
            if (response.status == 200) {
             window.location.reload();
            }
            console.log(response);
          },
          error: function () {
            alert("無法連線到伺服器！");
          }
        });
      } else {
        console.log("You pressed Cancel!");
      }
    }

    //report message data
    function report_message(id) {
      var check = window.confirm("確認舉報此筆留言？");
      if (check == true) {
        console.log("You pressed OK!");
        var request = {
          'id': id
        };
        var data_string = JSON.stringify(request);
        $.ajax({
          type: "POST",
          url: "api/comment.do",
          crossDomain: true,
          data: data_string,
          cache: false,
          dataType: 'json',
          timeout: 5000,
          success: function (response) {
            if (response.status == 200) {
              window.location.reload();
            }
            console.log(response);
          },
          error: function () {
            alert("無法連線到伺服器！");
          }
        });
      } else {
        console.log("You pressed Cancel!");
      }
    }


    //add message
    $("#add_message").click(function () {

      var data = {
        content: $("#leave_message").val(),
        discussion_id: id,
        user_id: 0,
      };

      // 驗證輸入的資料
      pass_vaild = vaildData(data);

      function vaildData(data) {
        if (
          data["content"] == ""
        )
          alert("必填寫欄位不得有空值！");
        else return true;

        return false;
      }

      var data_string = JSON.stringify(data);

      // 發出POST的AJAX請求
      $.ajax({
        type: "POST",
        url: "api/comment.do",
        data: data_string,
        crossDomain: true,
        cache: false,
        dataType: "json",
        timeout: 5000,
        success: function (response) {
          if (response.status == 200) {
            var message_data = '';
            document.getElementById('message_data').innerHTML="";
            $.each(response.response.data, function () {
              message_data += updateMessage(this);
            })

            $("#message_data").append(message_data);
          }
        },
        error: function () {
          alert("無法連線到伺服器！");
        },
      });

    });



    //redirect to parent page
    function redirect() {
      window.location.href = "discussion_board.html";
    }

    function updateMessage(data) {
      
      let temp = '';

      temp = '';
      temp += "<ul>";
      temp += "<li class='me-3 mt-3'>";
      temp += "<span>文章</span>";
      temp += "<span>" + data.content + "</span>";

      temp += "<span>使用者</span>";
      temp += "<span>" + data.user_id + "</span>";

      temp += "<a href='javascript: delete_message(" + data.id + ");' id='delete_message_" + data.id +
        "'class='btn btn-outline-danger float-end p-1 me-3 p-1' role='button'>刪除</a>";
      temp += "<a href='javascript: report_message(" + data.id + ");' id='report_message_" + data.id +
        "'class='btn btn-outline-warning float-end p-1 me-3 p-1' role='button'>檢舉</a>";

      temp += "</li>";
      temp += "</ul>";
         

      return temp;
    }

    function updateHTML(data) {
      $("#article_title").html(data[0]['article_title']);
      $("#article_content").html(data[0]['article_content']);
      $("#author").html(data[0]['author']);
      $("#id").html(data[0]['id']);
    }


    //account function
    function checkLogin() {
      $.ajax({
        type: "GET",
        url: "api/login.do",
        crossDomain: true,
        cache: false,
        dataType: "json",
        timeout: 5000,
        success: function (response) {
          if (response.status == 200) {
            let inner_html = "";
            if (response.response.status != "login") {
              //未登入
              inner_html +=
                '<li class="nav-item"><a class="nav-link" href="login.html">登入</a></li>';
            } else {
              name = response.response.name;
              //登入
              inner_html +=
                '<li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user me-1"></i>' +
                response.response.name +
                '</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="#"><i class="fas fa-info-circle me-1"></i>使用者資訊</a></li><li><hr class="dropdown-divider" /></li><li><a id="logout" class="dropdown-item" type="button" onclick="Logout()"><i class="fas fa-sign-out-alt me-1"></i>登出</a></li></ul></li>';
            }
            $("#loginOrNot").append(inner_html);
          }
          //console.log(response);
        },
        error: function () {
          alert("無法連線到伺服器！");
        },
      });
    }


    function Logout() {
      // 發出POST的AJAX請求
      $.ajax({
        type: "POST",
        url: "api/logout.do",
        crossDomain: true,
        cache: false,
        dataType: "json",
        timeout: 5000,
        success: function (response) {
          if (response.status == 200) {}
          //console.log(response);
        },
        error: function () {
          alert("無法連線到伺服器！");
        },
      });
      window.location.reload();
    }
    //end account function
  </script>

  <footer class="text-muted">
    <div class="container">
      <p class="float-right">
        <a href="#">Back to top</a>
      </p>
    </div>
  </footer>
</body>

</html>