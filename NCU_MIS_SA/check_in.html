<!DOCTYPE html>
<html>

<head>
    <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="" />
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors" />
  <meta name="generator" content="Jekyll v3.8.5" />

  <title>首頁 ｜ 報到手續</title>

  <!-- Bootstrap core CSS -->
  <link href="statics/css/bootstrap.min.css" rel="stylesheet" />
  <link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon" />
  <link href="statics/icon/favicon.ico" type="image/x-icon" rel="shortcut icon" />

  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous" />

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous">
  </script>

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  <!-- Custom styles for this template -->
  <link href="statics/css/product.css" rel="stylesheet" />

  <script src="statics/js/jquery-3.4.1.min.js"></script>
</head>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html"><i class="fas fa-bed me-1"></i> 宿舍管理系統</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0 ">
          <li class="nav-item">
		    <a class="nav-link" href="index.html">首頁</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="member.html"><strong>會員管理</strong></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">公告欄</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="discussion_board.html">討論版</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">宿舍繳費</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dormManagement.html">宿舍報修</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="check_in.html">報到手續</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">退宿手續</a>
          </li>
          <div id="loginOrNot">
          </div>
          
        </ul>
      </div>
    </div>
  </nav>
  
    <div id="container">
        <div id="header">
        	<h1 class="display-4">報到手續</h1>
        </div>
        <div id="content">
 

            <div id="flashMessage" class="message" style="display: none;"></div>

            <table id="table" >
                <thead>
                    <tr>
                        <th class="text-center" style="width: 10%">id</th>
                        <th class="text-center" style="width: 30%">user id</th>
                        <th  class="text-center" style="width: 10%">name</th>
                        <th class="text-center" style="width: 10%" id ="dorm_no">dorm</th>
                        <th class="text-center" style="width: 10%" id ="room_no">room</th>
                        <th class="text-center" style="width: 10%" id = "bed_no">bed</th>
                        <th class="text-center" style="width: 10%">check in status</th>
                        <th class="text-center" style="width: 10%">is damaged</th>
                        <!--  
                        <th>create time</th>
                        <th>modify time</th>
                        -->
                    </tr>
                    
                </thead>
                <tbody>
                </tbody>
            </table>
            
            <div>
            	<input type="checkbox" id="is_damaged" name="room_damaged_stat" value="1">
  				<label for="room_damaged"> My bed/room is damaged</label><br>
            
            </div>
            <div>
            
            	<button id="check" class="btn btn-primary btn-lg btn-block" type="button">Check-In</button>
            	<button id="cancel" class="btn btn-primary btn-lg btn-block" type="button" onclick="location.href='index.html';" >Cancel</button>
		      	
            </div>
            <script type="text/javascript">
                // 全域變數紀錄SQL指令下的次數
                var sql_num = 0;
                var email;

                $("#check").click(function () {
                	var data = {
                			"email": $('#loginOrNot').val(),
                			"is_damaged": $('#is_damaged').val(),
                			"dorm_no": $('#dorm_no').val(),
                			"room_no": $('#room_no').val(),
                			"bed_no": $('#bed_no').val()
                			
                	};

                	// 驗證輸入的資料
                	var data_string = JSON.stringify(data);

                		// 發出POST的AJAX請求
                    $.ajax({
                      type: "POST",
                      url: "api/check_in.do",
                      data: data_string,
                      crossDomain: true,
                      cache: false,
                      dataType: 'json',
                      timeout: 5000,
                      success: function (response) {
                          if(response.status == 100){
                          	$.confirm({
                                theme: 'modern',
                                icon: 'fa fa-check-circle-o',
                                type: 'green',
                                animation: 'scale',
                                title: '系統提醒',
                                content: "check-in success！",
                                buttons: {
                                    確定: {
                                        text: '確定',
                                        btnClass: 'btn-blue',
                                        action: function () {
                                          document.location.href = "index.html";
                                        }
                                    }
                                }
                            });
                          }
                          else if(response.status ==200){
                        	  
                          }
                      },
                      error: function () {
                          alert("DISCONNECTED TO SERVER！");
                          //無法連線到伺服器
                      }
                    });
                	//}
                });

                

                function getAllMember() {
                    // 發出POST的GET請求取得所有會員列表
                    $.ajax({
                            type: "GET",
                            url: "api/check_in.do",
                            crossDomain: true,
                            cache: false,
                            dataType: 'json',
                            timeout: 5000,
                            success: function (response) {
                                if(response.status == 200){
                                    updateTable(response.response.data);
                                    updateSQLTable(response.response);
                                }
                                console.log(response);
                            },
                            error: function () {
                                alert("ERROR GET ALL MEMBER");
                            }
                    });
                }
                
                // 更新會員列表表格
                function updateTable(data) {
                    $("#table > tbody").empty();
                    var table_html = '';
                    $.each(data, function(index, value) {
                    	 table_html += '<tr><td scope="row">' + value['id'] + '</td>';
                         table_html += '<td class="align-middle">' + value['user_id'] + '</td>';
                         table_html += '<td class="align-middle">' + value['name'] + '</td>';
                         table_html += '<td class="align-middle">' + value['dorm_no'] + '</td>';
                         table_html += '<td class="align-middle">' + value['room_no'] + '</td>';
                         table_html += '<td class="align-middle">' + value['bed_no'] + '</td>';
                         table_html += '<td class="align-middle">' + value['check_in_stat'] + '</td>';
                         table_html += '<td class="align-middle">' + value['is_damaged'] + '</td>';
                         //table_html += '<td>' + value['create_time'] + '</td>';
                         //table_html += '<td>' + value['modify_time'] + '</td>';
                        //table_html += '<td>' + '<a href="edit.html?id=' + value['id'] + '">編輯</a> | ';
                        //table_html += '<a href="javascript: deleteMember(' + value['id'] + ');">刪除</a></td></tr>';
                    })

                    $("#table > tbody").append(table_html);
                }
                
                // 更新SQL指令歷史表格
                function updateSQLTable(data) {
                    $("#sql_log > tbody").empty();
                    var time = (data.time / 1000000).toFixed(2);
                    var table_html = "";
                    
                    sql_num = 0;
                    sql_num += 1

                    table_html += '<tr>';
                    table_html += '<td>' + sql_num + '</td>';
                    table_html += '<td>' + data.sql + '</td>';
                    table_html += '<td style="text-align: right">' + '0' + '</td>';
                    table_html += '<td style="text-align: right">' + data.row + '</td>';
                    table_html += '<td style="text-align: right">' + data.row + '</td>';
                    table_html += '<td style="text-align: right">' + time + '</td>';
                    table_html += '</tr>';
                    $("#sql_log > tbody").append(table_html);
                    $("#sql_summary").html("(default) " + data.row + " queries took " + time + " ms");
                }
                
                
                $(document).ready(function() {
                    getAllMember();
                });
                
                
                function checkLogin(){
            	    $.ajax({
            	            type: "GET",
            	            url: "api/login.do",
            	            crossDomain: true,
            	            cache: false,
            	            dataType: 'json',
            	            timeout: 5000,
            	            success: function (response) {
            	                if(response.status == 200){
            						let inner_html='';
            	                	if(response.response.status != "login"){//未登入
            	                      	inner_html+='<li class="nav-item"><a class="nav-link" href="login.html">登入</a></li>';
            	                	}else{//登入
            	                		//email=response.response.email;
            	                		inner_html+='<li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user me-1"></i>'+response.response.email+'</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="#"><i class="fas fa-info-circle me-1"></i>使用者資訊</a></li><li><hr class="dropdown-divider" /></li><li><a id="logout" class="dropdown-item" type="button" onclick="Logout()"><i class="fas fa-sign-out-alt me-1"></i>登出</a></li></ul></li>';
            	                	}
            	                	$("#loginOrNot").append(inner_html);
            	                	
            	                }
            	                console.log(response);
            	            },
            	            error: function () {
            	                alert("無法連線到伺服器！");
            	            }
            	    });
              }
              checkLogin();
             function Logout() {
            	    // 發出POST的AJAX請求
            	    $.ajax({
            	      type: "POST",
            	      url: "api/logout.do",
            	      crossDomain: true,
            	      cache: false,
            	      dataType: "json",
            	      timeout: 5000,
            	      success: function (response) {
            	          if(response.status == 200){
            	          }
            	          console.log(response);
            	      },
            	      error: function () {
            	        alert("無法連線到伺服器！");
            	      },
            	    });
            	    window.location.reload();
              };
            </script>
        </div>
        <div id="footer">
            <a href="http://www.cakephp.org/" target="_blank" id="cake-powered"><img src="statics/img/cake.power.gif" alt="CakePHP: the rapid development php framework" border="0"></a>
            <p>CakePHP 2.6.10</p>
        </div>
    </div>
    <table class="cake-sql-log" id="sql_log" summary="Cake SQL Log" cellspacing="0">
        <caption id="sql_summary">(default) 0 query took 0 ms</caption>
        <thead>
            <tr>
                <th>Nr</th>
                <th>Query</th>
                <th>Error</th>
                <th>Affected</th>
                <th>Num. rows</th>
                <th>Took (ms)</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</body>

</html>
